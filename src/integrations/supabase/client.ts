// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { debugSupabaseClient } from '@/utils/authDebug';

const SUPABASE_URL = "https://bnulocsnxiffavvabfdj.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_Qf2Fc0CgFvljfVhk3v9IYg_PrDm9z4J";

// âœ… Singleton pattern: Uma Ãºnica instÃ¢ncia do cliente Supabase
let supabaseInstance: ReturnType<typeof createClient<Database>> | null = null;
let isInterceptorConfigured = false;

// âœ… ConfiguraÃ§Ã£o do interceptor uma Ãºnica vez
const configureRequestInterceptor = () => {
  if (isInterceptorConfigured) {
    console.log('ðŸ”§ [Supabase] Interceptor jÃ¡ configurado, pulando...');
    return;
  }

  console.log('ðŸ”§ [Supabase] Configurando interceptor de requisiÃ§Ãµes...');
  
  // âœ… Salvar referÃªncia original do fetch apenas uma vez
  const originalFetch = window.fetch;
  
  // âœ… Interceptor mais seguro - sÃ³ para URLs do Supabase
  window.fetch = async (input: RequestInfo | URL, init?: RequestInit) => {
    const url = typeof input === 'string' ? input : 
                input instanceof URL ? input.toString() : 
                input.url;
    
    // âœ… SÃ³ intercepta chamadas para sua instÃ¢ncia do Supabase
    if (url.includes('bnulocsnxiffavvabfdj.supabase.co/rest/') || 
        url.includes('bnulocsnxiffavvabfdj.supabase.co/functions/')) {
      
      const token = localStorage.getItem('siplan-auth-token');
      const headers = new Headers(init?.headers);
      
      if (token && !headers.has('Authorization')) {
        headers.set('Authorization', `Bearer ${token}`);
        console.log('ðŸ” [Supabase] JWT adicionado ao header para:', url.substring(0, 80) + '...');
      }
      
      return originalFetch(input, { ...init, headers });
    }
    
    // âœ… Para outras URLs, usar fetch original
    return originalFetch(input, init);
  };
  
  isInterceptorConfigured = true;
  console.log('âœ… [Supabase] Interceptor configurado com sucesso');
};

// âœ… FunÃ§Ã£o para obter a instÃ¢ncia Ãºnica
const getSupabaseInstance = () => {
  if (!supabaseInstance) {
    console.log('ðŸ”§ [Supabase] Criando instÃ¢ncia Ãºnica do cliente...');
    
    // âœ… Configurar interceptor apenas uma vez
    configureRequestInterceptor();
    
    supabaseInstance = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: {
        persistSession: false,  // âœ… JWT customizado
        autoRefreshToken: false,
        detectSessionInUrl: false,
        flowType: 'pkce', // âœ… Mais seguro para SPAs
      },
      global: {
        headers: {
          'x-client-info': 'siplan-web-client/1.0.0', // âœ… Identificador customizado
        },
      },
      realtime: {
        params: {
          eventsPerSecond: 10, // âœ… Controle de performance
        },
      },
    });
    
    debugSupabaseClient();
    console.log('âœ… [Supabase] Cliente configurado com sucesso');
  }
  return supabaseInstance;
};

// âœ… Export da instÃ¢ncia Ãºnica
export const supabase = getSupabaseInstance();

// âœ… FunÃ§Ãµes de gestÃ£o de token simplificadas
export const setAuthToken = (token: string) => {
  console.log('ðŸ” [AuthToken] Salvando JWT no localStorage');
  localStorage.setItem('siplan-auth-token', token);
};

export const clearAuthToken = () => {
  console.log('ðŸ” [AuthToken] Removendo JWT do localStorage');
  localStorage.removeItem('siplan-auth-token');
};

export const getAuthToken = (): string | null => {
  return localStorage.getItem('siplan-auth-token');
};

// âœ… FunÃ§Ãµes de compatibilidade (aliases)
export const setCartorioAuthContext = setAuthToken;
export const clearCartorioAuthContext = clearAuthToken;
export const getAuthenticatedClient = getSupabaseInstance;
export const createAuthenticatedClient = (token: string) => {
  setAuthToken(token);
  return getSupabaseInstance();
};
export const setCustomAuthToken = setAuthToken;
export const clearCustomAuthToken = clearAuthToken;

// âœ… FunÃ§Ã£o para resetar completamente (Ãºtil para testes)
export const resetSupabaseClient = () => {
  console.log('ðŸ”„ [Supabase] Resetando cliente...');
  supabaseInstance = null;
  isInterceptorConfigured = false;
  clearAuthToken();
};
