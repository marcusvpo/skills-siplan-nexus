
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { debugSupabaseClient } from '@/utils/authDebug';

const SUPABASE_URL = "https://bnulocsnxiffavvabfdj.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJudWxvY3NueGlmZmF2dmFiZmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NzM1NTMsImV4cCI6MjA2NjQ0OTU1M30.3QeKQtbvTN4KQboUKhqOov16HZvz-xVLxmhl70S2IAE";

// Singleton pattern: Uma √∫nica inst√¢ncia do cliente Supabase para toda a aplica√ß√£o
let supabaseInstance: ReturnType<typeof createClient<Database>> | null = null;

// Fun√ß√£o para obter a inst√¢ncia √∫nica do cliente Supabase
const getSupabaseInstance = () => {
  if (!supabaseInstance) {
    console.log('üîß [Supabase] Creating single client instance');
    supabaseInstance = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: {
        persistSession: true, // Mant√©m a sess√£o persistente
        autoRefreshToken: true, // Auto-refresh de tokens
        detectSessionInUrl: true,
        storage: typeof window !== 'undefined' ? window.localStorage : undefined,
        storageKey: 'supabase.auth.token',
      },
      global: {
        headers: {
          'x-client-info': 'supabase-js-web/2.50.2'
        },
      },
    });
    
    // Debug apenas em desenvolvimento
    debugSupabaseClient();
  }
  return supabaseInstance;
};

// Export da inst√¢ncia √∫nica
// Sistema de gerenciamento de contexto de autentica√ß√£o para cart√≥rios
class AuthContextManager {
  private currentToken: string | null = null;
  private currentHeaders: Record<string, string> = {};

  setCartorioContext(token: string) {
    console.log('üîê [AuthContext] Setting cartorio context with token type:', token.startsWith('CART-') ? 'CART token' : 'JWT token');
    
    this.currentToken = token;
    this.currentHeaders = {};
    
    // Para JWT customizado ou tokens de cart√≥rio
    this.currentHeaders = {
      'Authorization': `Bearer ${token}`,
    };
    
    // Interceptar todas as requisi√ß√µes do Supabase para incluir o JWT
    this.interceptSupabaseRequests(token);
  }

  private interceptSupabaseRequests(token: string) {
    const client = getSupabaseInstance();
    
    // Interceptar requisi√ß√µes usando a funcionalidade nativa do Supabase
    client.auth.getSession().then(({ data: { session } }) => {
      if (!session || session.access_token !== token) {
        // Se n√£o h√° sess√£o ativa ou o token √© diferente, configurar o token customizado
        // Configurar o token no cabe√ßalho global do cliente
        const originalFetch = global.fetch;
        global.fetch = async (input: RequestInfo | URL, init?: RequestInit) => {
          const url = typeof input === 'string' ? input : input.toString();
          
          // Interceptar apenas requisi√ß√µes para o Supabase
          if (url.includes('bnulocsnxiffavvabfdj.supabase.co')) {
            const headers = new Headers(init?.headers);
            
            // Se j√° n√£o tem Authorization header ou √© diferente, usar o token customizado
            if (!headers.get('Authorization') || headers.get('Authorization') !== `Bearer ${token}`) {
              headers.set('Authorization', `Bearer ${token}`);
            }
            
            return originalFetch(input, {
              ...init,
              headers
            });
          }
          
          return originalFetch(input, init);
        };
      }
    });
  }

  clearContext() {
    console.log('üîê [AuthContext] Clearing cartorio context');
    this.currentToken = null;
    this.currentHeaders = {};
    
    // Restaurar fetch original se foi interceptado
    if (global.fetch && (global.fetch as any).__originalFetch) {
      global.fetch = (global.fetch as any).__originalFetch;
    }
  }

  getHeaders(): Record<string, string> {
    return { ...this.currentHeaders };
  }

  hasContext(): boolean {
    return this.currentToken !== null;
  }

  getCurrentToken(): string | null {
    return this.currentToken;
  }
}

// Inst√¢ncia √∫nica do gerenciador de contexto
const authContextManager = new AuthContextManager();

// Export da inst√¢ncia √∫nica do Supabase com intercepta√ß√£o configurada
export const supabase = getSupabaseInstance();

// Fun√ß√£o para configurar o contexto de autentica√ß√£o de cart√≥rio
export const setCartorioAuthContext = (token: string) => {
  authContextManager.setCartorioContext(token);
};

// Fun√ß√£o para limpar o contexto de autentica√ß√£o de cart√≥rio
export const clearCartorioAuthContext = () => {
  authContextManager.clearContext();
};

// Fun√ß√£o para obter cliente com contexto de autentica√ß√£o apropriado
export const getAuthenticatedClient = () => {
  // Sempre retorna a inst√¢ncia √∫nica do cliente Supabase
  // O contexto de cart√≥rio √© gerenciado via headers nas Edge Functions
  return getSupabaseInstance();
};

// Helper function compat√≠vel com o c√≥digo existente
export const createAuthenticatedClient = (token: string) => {
  console.log('üîê [createAuthenticatedClient] Setting up context for token type:', token.startsWith('CART-') ? 'CART token' : 'Other token');
  
  // Em vez de criar nova inst√¢ncia, configuramos o contexto
  setCartorioAuthContext(token);
  
  // Retorna a inst√¢ncia √∫nica configurada
  return getAuthenticatedClient();
};

// Fun√ß√µes de compatibilidade (mantidas para n√£o quebrar c√≥digo existente)
export const setCustomAuthToken = (token: string) => {
  console.log('Setting custom auth token via compatibility function:', token);
  setCartorioAuthContext(token);
};

export const clearCustomAuthToken = () => {
  console.log('Clearing custom auth token via compatibility function');
  clearCartorioAuthContext();
};
