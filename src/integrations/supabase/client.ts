// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { debugSupabaseClient } from '@/utils/authDebug';

const SUPABASE_URL = "https://bnulocsnxiffavvabfdj.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJudWxvY3NueGlmZmF2dmFiZmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NzM1NTMsImV4cCI6MjA2NjQ0OTU1M30.3QeKQtbvTN4KQboUKhqOov16HZvz-xVLxmhl70S2IAE";

// Singleton pattern: Uma √∫nica inst√¢ncia do cliente Supabase para toda a aplica√ß√£o
let supabaseInstance: ReturnType<typeof createClient<Database>> | null = null;

// Fun√ß√£o para obter a inst√¢ncia √∫nica do cliente Supabase com interceptor global
const getSupabaseInstance = () => {
  if (!supabaseInstance) {
    console.log('üîß [Supabase] Creating single client instance');
    
    // Sobrescrever global.fetch para interceptar requests e adicionar JWT
    const originalFetch = global.fetch;
    global.fetch = async (input: RequestInfo | URL, init?: RequestInit) => {
      const url = typeof input === 'string' ? input : input.toString();
      
      // Interceptar apenas requests para Supabase (incluindo Edge Functions)
      if (url.includes('bnulocsnxiffavvabfdj.supabase.co')) {
        const token = localStorage.getItem('siplan-auth-token');  // Token armazenado ap√≥s login
        const headers = new Headers(init?.headers);
        
        if (token && !headers.get('Authorization')) {
          headers.set('Authorization', `Bearer ${token}`);
          console.log('üîê [Supabase Fetch] Adding Authorization header with JWT');
        } else if (!token) {
          console.warn('‚ö†Ô∏è [Supabase Fetch] No JWT found in localStorage - request may fail authorization');
        }
        
        return originalFetch(input, {
          ...init,
          headers
        });
      }
      
      return originalFetch(input, init);
    };
    
    supabaseInstance = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: {
        persistSession: false,  // Desativado, pois usamos JWT customizado
        autoRefreshToken: false,
        detectSessionInUrl: false,
        storage: typeof window !== 'undefined' ? window.localStorage : undefined,
        storageKey: 'siplan-auth-token',  // Chave para JWT customizado
      },
      global: {
        headers: {
          'x-client-info': 'supabase-js-web/2.50.2'
        },
      },
    });
    
    // Debug apenas em desenvolvimento
    debugSupabaseClient();
  }
  return supabaseInstance;
};

// Export da inst√¢ncia √∫nica
export const supabase = getSupabaseInstance();

// Fun√ß√µes auxiliares para gerenciar token (use no AuthContext)
export const setAuthToken = (token: string) => {
  console.log('üîê [AuthToken] Setting JWT in localStorage');
  localStorage.setItem('siplan-auth-token', token);
};

export const clearAuthToken = () => {
  console.log('üîê [AuthToken] Clearing JWT from localStorage');
  localStorage.removeItem('siplan-auth-token');
};

// Fun√ß√µes de compatibilidade (mantidas para n√£o quebrar c√≥digo existente)
export const setCartorioAuthContext = (token: string) => {
  setAuthToken(token);  // Redireciona para setAuthToken
};

export const clearCartorioAuthContext = () => {
  clearAuthToken();  // Redireciona para clearAuthToken
};

export const getAuthenticatedClient = () => {
  return getSupabaseInstance();  // Retorna a inst√¢ncia com interceptor
};

export const createAuthenticatedClient = (token: string) => {
  setAuthToken(token);
  return getAuthenticatedClient();
};

export const setCustomAuthToken = (token: string) => {
  setAuthToken(token);
};

export const clearCustomAuthToken = () => {
  clearAuthToken();
};
